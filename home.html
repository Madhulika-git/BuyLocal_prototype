
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BuyLocal</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f0f4f8;
}

/* Header */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 30px;
  background-color: #ffffff;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  position: sticky;
  top: 0;
  z-index: 100;
}
header img { height: 120px; }
.search-bar input {
  padding: 10px 15px;
  width: 300px;
  border-radius: 25px;
  border: 1px solid #ccc;
  outline: none;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.add-shop-btn {
  padding: 12px 25px;
  background-color: #ff6b6b;
  color: white;
  border-radius: 25px;
  text-decoration: none;
  font-weight: bold;
  transition: 0.3s;
}
.add-shop-btn:hover { background-color: #ff4b4b; }

/* Nearby Button */
#findNearbyBtn {
  padding: 10px 18px;
  background-color: #6c5ce7;
  color: white;
  border: none;
  border-radius: 25px;
  margin-left: 10px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s;
}
#findNearbyBtn:hover { background-color: #5b4ed7; }

/* Profile Icon */
#profileIcon {
  width:45px; height:45px; border-radius:50%; background:#6c5ce7; color:white;
  display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; font-size:18px;
  margin-left:15px;
  transition: transform 0.2s ease, background 0.3s;
}
#profileIcon:hover { transform: scale(1.1); background:#5b4ed7; }

/* Fancy Dropdown */
#profileDropdown {
  display:none;
  position:absolute;
  top:60px;
  right:0;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  overflow:hidden;
  z-index:300;
  width:180px;
  animation: dropdownFade 0.25s ease;
}

#profileDropdown p {
  margin:0;
  padding:12px 18px;
  font-size:15px;
  color:#333;
  cursor:pointer;
  transition: background 0.3s, color 0.3s;
}
#profileDropdown p:hover {
  background:#f0f0ff;
  color:#5b4ed7;
}

@keyframes dropdownFade {
  from { opacity:0; transform: translateY(-10px); }
  to { opacity:1; transform: translateY(0); }
}

/* Categories */
.categories-container {
  display: flex;
  overflow-x: auto;
  padding: 20px;
  gap: 20px;
  scroll-behavior: smooth;
  scroll-snap-type: x mandatory;
}
.categories-container::-webkit-scrollbar { height: 8px; }
.categories-container::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}
.category-card {
  flex: 0 0 auto;
  width: 280px;
  height: 180px;
  border-radius: 20px;
  position: relative;
  color: white;
  font-weight: bold;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  text-align: center;
  padding-bottom: 20px;
  background-size: cover;
  background-position: center;
  transition: transform 0.3s, box-shadow 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  scroll-snap-align: start;
}
.category-card::before {
  content:'';
  position:absolute; top:0; left:0; width:100%; height:100%;
  border-radius:20px;
  background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.6) 100%);
  z-index:0;
}
.category-card span { position: relative; z-index:1; }
.category-card:hover {
  transform: scale(1.07);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

/* Shops */
.shop-section { padding: 20px; max-height: 500px; overflow-y: auto; }
.shop-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}
.shop-card {
  border-radius: 15px;
  background: #ffffff;
  padding: 15px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  height: 200px;
  position: relative;
}
.shop-card::before {
  content:'';
  position:absolute; top:0; left:0; width:100%; height:100%;
  border-radius:15px;
  background: linear-gradient(to bottom, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
  z-index:0;
}
.shop-card:hover {
  transform: scale(1.03);
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
}
.shop-card-info {
  position: relative;
  z-index: 1;
  color: white;
  text-shadow: 1px 1px 4px rgba(0,0,0,0.7);
  padding: 10px;
}

/* Modal */
.modal { display:none; position:fixed; z-index:200; left:0; top:0; width:100%; height:100%; overflow-y:auto; background-color: rgba(0,0,0,0.7); padding-top:50px; animation:fadeIn 0.3s ease; }
.modal-content {
  background-color:#fff;
  margin:auto;
  padding:25px;
  border-radius:15px;
  width:90%;
  max-width:900px;
  max-height:80vh;
  overflow-y:auto;
  display:grid;
  grid-template-columns: 1fr;
  gap:15px;
}
@media(min-width:800px){ .modal-content { grid-template-columns: repeat(2,1fr); } }
.close-btn { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
.close-btn:hover { color:black; }

.products, .sales, .contact, .social, .navigate {
  background: #f7f9fc;
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 15px;
}
.products h3, .sales h3, .contact h3, .social h3, .navigate h3 { margin-top:0; color:#333; }

/* Carousel */
.carousel-container { position: relative; display: flex; align-items: center; overflow: hidden; margin-top: 10px; }
.carousel-slider { display: flex; overflow-x: auto; gap: 10px; scroll-behavior: smooth; padding: 10px 0; }
.carousel-slider::-webkit-scrollbar { display: none; }
.carousel-slider img { flex:0 0 auto; width:150px; height:150px; object-fit:cover; border-radius:10px; transition:transform 0.3s; cursor:pointer; }
.carousel-slider img:hover { transform:scale(1.05); }
.carousel-arrow { position:absolute; top:50%; transform:translateY(-50%); background: rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:35px; height:35px; cursor:pointer; z-index:10; }
.carousel-arrow.left { left:5px; } .carousel-arrow.right { right:5px; }

@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="BuyLocal Logo">
  <div style="display:flex; align-items:center; gap:15px; position:relative;">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search shops or products...">
      <button id="findNearbyBtn">üìç Find Nearby Shops</button>
    </div>
    <a href="addshop.html" class="add-shop-btn">Add Your Shop</a>

    <div id="profileIcon">U</div>
    <div id="profileDropdown">
      <p id="accountSettings">Account Settings</p>
      <p id="logoutDropdownBtn">Logout</p>
    </div>
  </div>
</header>

<h2 style="padding-left:20px;">Categories</h2>
<div class="categories-container" id="categoryContainer"></div>

<h2 style="padding-left:20px;">Shops</h2>
<div class="shop-section">
  <div class="shop-list" id="shopList">
    <p style="padding:20px;">Select a category to see shops.</p>
  </div>
</div>

<div id="shopModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="modalClose">&times;</span>
    <h2 id="modalShopName"></h2>
    <p id="modalShopAddress"></p>

    <div class="carousel-container">
      <button class="carousel-arrow left" id="carouselLeft">&#8592;</button>
      <div class="carousel-slider" id="modalShopImages"></div>
      <button class="carousel-arrow right" id="carouselRight">&#8594;</button>
    </div>

    <div class="products" id="modalProducts"></div>
    <div class="sales" id="modalSales"></div>
    <div class="contact" id="modalContact"></div>
    <div class="social" id="modalSocial"></div>
    <div class="navigate" id="modalNavigate"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAtsmXck_fS5-iXK3r_17ND4GJ-pfhBrZc",
  authDomain: "buylocal-b1f0f.firebaseapp.com",
  projectId: "buylocal-b1f0f",
  storageBucket: "buylocal-b1f0f.firebasestorage.app",
  messagingSenderId: "461692300773",
  appId: "1:461692300773:web:263d2b30ec0dfa95c6530c"
};


const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let logged = JSON.parse(localStorage.getItem('loggedInUser')||'null');
if(!logged){ alert('Please login'); window.location.href='login.html'; }

const profileIcon = document.getElementById('profileIcon');
const profileDropdown = document.getElementById('profileDropdown');
profileIcon.textContent = logged.name ? logged.name[0].toUpperCase() : 'U';
if(logged.profilePic && logged.profilePic.trim()!==''){
  profileIcon.style.backgroundImage = `url('${logged.profilePic}')`;
  profileIcon.style.backgroundSize = 'cover';
  profileIcon.style.backgroundPosition = 'center';
  profileIcon.textContent = '';
}
profileIcon.onclick = () => {
  profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
};
window.onclick = (e) => {
  if(e.target !== profileIcon && !profileDropdown.contains(e.target)){
    profileDropdown.style.display = 'none';
  }
}
document.getElementById('accountSettings').onclick = () => { window.location.href = 'account.html'; };
document.getElementById('logoutDropdownBtn').onclick = () => {
  localStorage.removeItem('loggedInUser');
  window.location.href = 'login.html';
};

// Shop logic
const shopList = document.getElementById('shopList');
const categoryContainer = document.getElementById('categoryContainer');
const searchInput = document.getElementById('searchInput');
const findNearbyBtn = document.getElementById('findNearbyBtn');

const predefinedCategories = {
  'Bakery':'bakery.png',
  'Ice Cream':'ice_cream.png',
  'Cafe':'cafe.png',
  'Flower Shops':'flowers.png',
  'Spa':'spa.png',
  'Grocery':'grocery.png'
};

// Firebase functions
async function getShops() {
  const shopCol = collection(db, "shops");
  const shopSnapshot = await getDocs(shopCol);
  const shops = shopSnapshot.docs.map(doc => doc.data());
  return shops;
}

async function getCategories() {
  const shops = await getShops();
  const categoryImages = {...predefinedCategories};
  shops.forEach(shop=>{
    if (!(shop.category in categoryImages) && shop.categoryImage)
      categoryImages[shop.category]=shop.categoryImage;
  });
  return categoryImages;
}

async function displayCategories() {
  categoryContainer.innerHTML='';
  const categories = await getCategories();
  for(let category in categories){
    const card=document.createElement('div');
    card.classList.add('category-card');
    if(categories[category]) card.style.backgroundImage=`url('${categories[category]}')`;
    card.innerHTML=`<span>${category}</span>`;
    card.onclick=()=>showShops(category);
    categoryContainer.appendChild(card);
  }
}

async function showShops(category){
  const shops = (await getShops()).filter(s=>s.category===category);
  displayShops(shops);
}

// Search
searchInput.addEventListener('input', async ()=>{
  const q = searchInput.value.toLowerCase();
  const shops = (await getShops()).filter(s=>
    s.name.toLowerCase().includes(q) ||
    s.category.toLowerCase().includes(q) ||
    (s.products && s.products.some(p=>p.toLowerCase().includes(q)))
  );
  displayShops(shops);
});

// Find nearby
findNearbyBtn.addEventListener('click', async ()=>{
  if(!navigator.geolocation){
    alert('Geolocation not supported on this device.');
    return;
  }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude, longitude} = pos.coords;
    const shops = (await getShops()).filter(s=>s.latitude && s.longitude);
    if(!shops.length){ alert('No shop locations available.'); return; }

    const dist = (lat1, lon1, lat2, lon2)=>{
      const R=6371;
      const dLat=(lat2-lat1)*Math.PI/180;
      const dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    };

    shops.forEach(s=>{ s.distance = dist(latitude, longitude, s.latitude, s.longitude); });
    shops.sort((a,b)=>a.distance-b.distance);
    displayShops(shops);
  },()=>{
    alert('Unable to access location.');
  });
});

// Modal elements
const modal = document.getElementById('shopModal');
const modalClose = document.getElementById('modalClose');
const modalShopName = document.getElementById('modalShopName');
const modalShopAddress = document.getElementById('modalShopAddress');
const modalShopImages = document.getElementById('modalShopImages');
const modalProducts = document.getElementById('modalProducts');
const modalSales = document.getElementById('modalSales');
const modalContact = document.getElementById('modalContact');
const modalSocial = document.getElementById('modalSocial');
const modalNavigate = document.getElementById('modalNavigate');
const carouselLeft = document.getElementById('carouselLeft');
const carouselRight = document.getElementById('carouselRight');

function displayShops(shops){
  shopList.innerHTML='';
  if(!shops.length){ shopList.innerHTML='<p style="padding:20px;">No shops found.</p>'; return; }
  shops.forEach(shop=>{
    const card=document.createElement('div');
    card.className='shop-card';
    if(shop.image && shop.image[0]) card.style.backgroundImage=`url('${shop.image[0]}')`;
    card.innerHTML=`<div class="shop-card-info"><h3>${shop.name}</h3><p>${shop.address || ''}</p></div>`;
    card.onclick=()=>openModal(shop);
    shopList.appendChild(card);
  });
}

function openModal(shop){
  modal.style.display='block';
  modalShopName.textContent=shop.name;
  modalShopAddress.textContent=shop.address;

  modalShopImages.innerHTML='';
  if(shop.image && shop.image.length>0){
    shop.image.forEach(img=>{
      const i = document.createElement('img');
      i.src = img;
      modalShopImages.appendChild(i);
    });
  }

  carouselLeft.onclick = () => { modalShopImages.scrollBy({ left: -160, behavior:'smooth'}); }
  carouselRight.onclick = () => { modalShopImages.scrollBy({ left: 160, behavior:'smooth'}); }

  modalProducts.innerHTML='';
  if(shop.products && shop.products.length>0)
    modalProducts.innerHTML='<h3>Products:</h3><ul>'+shop.products.map(p=>`<li>${p}</li>`).join('')+'</ul>';

  modalSales.innerHTML='';
  if(shop.sales && shop.sales.length>0)
    modalSales.innerHTML='<h3>Sales Info:</h3><div>'+shop.sales.map(s=>`<img src="${s}" style="width:120px;height:120px;margin:5px;">`).join('')+'</div>';

  modalContact.innerHTML='';
  if(shop.contact && shop.contact.trim()!=='')
    modalContact.innerHTML='<h3>Contact Info:</h3><p>'+shop.contact+'</p>';

  modalSocial.innerHTML='';
  if(shop.social && shop.social.trim()!=='')
    modalSocial.innerHTML='<h3>Social Media:</h3><p>'+shop.social+'</p>';

  modalNavigate.innerHTML='';
  if(shop.address && shop.address.trim()!==''){
    const btn = document.createElement('button');
    btn.textContent = 'Navigate';
    btn.style.cssText = 'padding:8px 12px; border:none; border-radius:8px; background:#6c5ce7; color:white; cursor:pointer;';
    btn.onclick = ()=> window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(shop.address)}`, '_blank');
    modalNavigate.appendChild(btn);
  }
}

modalClose.onclick=()=>modal.style.display='none';
window.onclick=e=>{if(e.target==modal) modal.style.display='none';};

displayCategories();
</script>
</body>
</html>
